<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Smart Homework Organizer</title>
        <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
        <style>
            :root{
                --bg1:hsl(217, 41%, 10%);
                --bg2:hsl(220, 49%, 8%);
                --card:#071127;
                --muted:#9aa4b2;
                --accent:#7c5cff;
                --accent-2:#00c2a8;
                --accent-3:#ffd166;
                --glass: rgba(255,255,255,0.03);
            }
            *{box-sizing:border-box}
            body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.08), transparent 10%), linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8;min-height:100vh}
            header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px}
            .brand{display:flex;align-items:center;gap:12px}
            .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:inline-flex;align-items:center;justify-content:center;color:#061225;font-weight:800}
            .container{max-width:1200px;margin:20px auto;padding:18px}
            .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}

            .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
            .panel h2{margin:0 0 8px;font-size:16px;color:#eaf0ff}
            .todo-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
            .task{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;background:var(--glass)}
            .task small{color:var(--muted)}
            .task .actions{display:flex;gap:8px}
            .btn{background:linear-gradient(90deg,var(--accent),#5f79ff);color:#061225;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
            .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(124,92,255,0.18)}
            .btn.warn{background:linear-gradient(90deg,#ff7b7b,#ff4d4d);color:#120406}

            .calendar-wrap{display:flex;flex-direction:column;gap:12px}
            .cal-day{cursor:default}
            .cal-day:hover{cursor:pointer;transform:translateY(-2px);transition:transform .12s}
            .cal-day.today{background:linear-gradient(135deg,var(--accent-2),var(--accent));box-shadow:0 6px 18px rgba(124,92,255,0.14);border:1px solid rgba(124,92,255,0.22)}
            .cal-day.selected{outline:3px solid rgba(0,194,168,0.12);box-shadow:0 8px 20px rgba(0,194,168,0.06)}
            .todo-list.flash{animation:flash 900ms ease}
            @keyframes flash{0%{box-shadow:0 0 0 rgba(0,0,0,0)}50%{box-shadow:0 12px 36px rgba(124,92,255,0.12)}100%{box-shadow:0 0 0 rgba(0,0,0,0)}}
            .cal-header{display:flex;justify-content:space-between;align-items:center}
            .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
            .cal-day{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:10px;border-radius:10px;min-height:96px;border:1px solid rgba(255,255,255,0.02)}
            .cal-day .date{font-weight:700;color:#eaf0ff}
            .cal-day .dots{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
            .dot{width:8px;height:8px;border-radius:50%;background:var(--accent-3)}

            .ocr-area{margin-top:12px;display:flex;gap:12px;align-items:flex-start}
            .ocr-area textarea{width:100%;min-height:88px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);color:#eaf0ff}

            footer{margin:28px 0;text-align:center;color:var(--muted);font-size:13px}

            .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(1,3,9,0.6), rgba(1,3,9,0.6))}
            .modal .box{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;max-width:540px;width:100%;border:1px solid rgba(255,255,255,0.03)}

            @media (max-width:920px){.grid{grid-template-columns:1fr;}.container{padding:12px}}
        </style>
    </head>
    <body>
        <header>
            <div class="brand">
                <div class="logo">SH</div>
                <div>
                    <div style="font-weight:700">Smart Homework Organizer</div>
                    <div style="font-size:13px;color:var(--muted)">Organize tasks, calendar, OCR hints — beginner friendly</div>
                </div>
            </div>
            <div></div>
        </header>

        <main class="container">
            <div class="grid">
                <aside class="panel">
                    <h2>Today's Tasks</h2>
                    <div style="display:flex;gap:8px;margin-top:12px">
                        <button id="addTaskBtn" class="btn">+ New Task</button>
                        <button id="scanBtn" class="btn secondary">OCR + Hints</button>
                    </div>

                    <div class="todo-list" id="todoList"></div>

                    <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
                        <label style="font-size:13px;color:var(--muted)">Notifications</label>
                        <input type="checkbox" id="enableNotif" />
                    </div>

                    <div style="margin-top:12px;font-size:13px;color:var(--muted)">Tip: The app stores data locally in your browser. For persistent notifications when the page is closed consider installing as a PWA or keeping the page open.</div>
                </aside>

                <section>
                    <div class="panel calendar-wrap">
                        <div class="cal-header">
                            <div style="display:flex;gap:8px;align-items:center">
                                <button id="prevMonth" class="btn secondary">‹</button>
                                <div style="font-weight:700" id="monthLabel">Month</div>
                                <button id="nextMonth" class="btn secondary">›</button>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center">
                                <button id="todayBtn" class="btn secondary">Today</button>
                            </div>
                        </div>

                        <div class="cal-grid" id="calGrid"></div>
                    </div>

                    <div class="panel" style="margin-top:12px">
                        <h2>OCR & Hints</h2>
                        <div class="ocr-area">
                            <div style="width:240px;display:flex;flex-direction:column;gap:8px">
                                <input type="file" id="imageInput" accept="image/*" />
                                <button id="runOcrBtn" class="btn">Run OCR</button>
                                <div style="font-size:13px;color:var(--muted)">Or paste text into the box on the right.</div>
                                <div style="margin-top:8px;font-size:12px;color:var(--muted)">Use remote AI hints (OpenAI) by running the provided local server and setting <code>OPENAI_API_KEY</code>.</div>
                            </div>
                            <div style="flex:1;display:flex;flex-direction:column;gap:8px">
                                <textarea id="ocrText" placeholder="OCR output or paste problem text here..."></textarea>
                                <div style="display:flex;gap:8px;align-items:center">
                                    <button id="genHintsBtn" class="btn">Generate Hints</button>
                                    <button id="copyHints" class="btn secondary">Copy Hints</button>
                                </div>
                                <div id="hintsArea" style="background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);min-height:60px;color:#eaf0ff"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <footer>made by erwin 100%</footer>
        </main>

        
            <div class="modal" id="taskModal">
            <div class="box">
                <h3 id="modalTitle">New Task</h3>
                <div style="display:grid;gap:8px;margin-top:8px">
                    <input id="taskTitle" placeholder="Title (e.g., Math homework)" />
                    <input id="taskDate" type="date" />
                    <input id="taskTime" type="time" />
                    <textarea id="taskDesc" placeholder="Short description or problem text"></textarea>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button id="saveTask" class="btn">Save</button>
                        <button id="closeModal" class="btn secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
        <script>
            const state = { tasks: [], selectedDate: todayISOLocal(), notifEnabled: false };

            function pad(n){return String(n).padStart(2,'0')}
            function todayISOLocal(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
            function ymdToDate(ymd){
                if(!ymd) return null;
                const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if(!m) return null;
                return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
            }
            function viewKeyFromDate(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}

            function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}
            function normalizeDateInput(s){
                if(!s) return '';
                s = String(s).trim();
                if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                const m = s.match(/^\s*(\d{1,2})[\.\-/](\d{1,2})[\.\-/](\d{4})\s*$/);
                if(m){
                    // Interpret ambiguous numeric dates as day-first (dd.mm.yyyy) unless month > 12
                    let d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);
                    if(mo>12 && d<=12){ // looks like mm.dd.yyyy -> swap
                        const tmp = d; d = mo; mo = tmp;
                    }
                    // otherwise prefer day-first
                    const day = pad(d);
                    const month = pad(mo);
                    return `${y}-${month}-${day}`;
                }
                return s;
            }
            function formatDate(d){return d}

            function loadTasks(){
                try{state.tasks = JSON.parse(localStorage.getItem('sh_tasks')||'[]')}catch(e){state.tasks=[]}
            }
            function saveTasks(){localStorage.setItem('sh_tasks',JSON.stringify(state.tasks)); saveState();}

            function saveState(){
                try{
                    localStorage.setItem('sh_selectedDate', state.selectedDate || '');
                    // store view month as YYYY-MM to avoid timezone shifts
                    localStorage.setItem('sh_viewDate', viewDate.getFullYear() + '-' + pad(viewDate.getMonth()+1));
                    localStorage.setItem('sh_notif', state.notifEnabled ? 'true' : 'false');
                    try{localStorage.setItem('sh_ocrText', document.getElementById('ocrText').value || '');}catch(e){}
                    try{localStorage.setItem('sh_hints', document.getElementById('hintsArea').innerText || '');}catch(e){}
                }catch(e){console.warn('saveState failed', e)}
            }

            function loadState(){
                try{
                    const sd = localStorage.getItem('sh_selectedDate');
                    if(sd) state.selectedDate = sd;
                    const vd = localStorage.getItem('sh_viewDate');
                    if(vd){
                        const m = String(vd).match(/^(\d{4})-(\d{2})$/);
                        if(m) viewDate = new Date(parseInt(m[1],10), parseInt(m[2],10)-1, 1);
                        else {
                            // fallback for older stored ISO strings
                            const parsed = new Date(vd);
                            if(!isNaN(parsed)) viewDate = new Date(parsed.getFullYear(), parsed.getMonth(), 1);
                        }
                    }
                    const o = localStorage.getItem('sh_ocrText');
                    if(o) try{document.getElementById('ocrText').value = o;}catch(e){}
                    const h = localStorage.getItem('sh_hints');
                    if(h) try{document.getElementById('hintsArea').innerText = h;}catch(e){}
                    const n = localStorage.getItem('sh_notif');
                    state.notifEnabled = n === 'true';
                }catch(e){console.warn('loadState failed', e)}
            }

            const calGrid = document.getElementById('calGrid');
            const monthLabel = document.getElementById('monthLabel');
            let viewDate = new Date();

            function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
            function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}

            function renderCalendar(){
                calGrid.innerHTML='';
                const start = startOfMonth(viewDate);
                const end = endOfMonth(viewDate);
                monthLabel.textContent = viewDate.toLocaleString(undefined,{month:'long',year:'numeric'});
                const startWeekday = start.getDay();
                const total = end.getDate();
                const todayKey = todayISOLocal();

                for(let i=0;i<startWeekday;i++){const cell=document.createElement('div');cell.className='cal-day';cell.style.opacity=.4;calGrid.appendChild(cell)}

                for(let d=1;d<=total;d++){
                    const dt = new Date(viewDate.getFullYear(),viewDate.getMonth(),d);
                    const key = viewKeyFromDate(dt);
                    const cell=document.createElement('div');cell.className='cal-day';
                    cell.innerHTML = `<div class="date">${d}</div><div class="dots" data-date="${key}"></div>`;
                    if(key===todayKey) cell.classList.add('today');
                    if(key===state.selectedDate) cell.classList.add('selected');
                    cell.addEventListener('click',()=>{
                        state.selectedDate=key;
                        renderCalendar();
                        renderTodoList();
                        try{todoListEl.scrollIntoView({behavior:'smooth',block:'start'});}catch(e){}
                        todoListEl.classList.add('flash');
                        setTimeout(()=>todoListEl.classList.remove('flash'),900);
                        saveState();
                    });

                    const dots = cell.querySelector('.dots');
                    const tasks = state.tasks.filter(t=>t.date===key);
                    tasks.slice(0,5).forEach(t=>{const dot=document.createElement('div');dot.className='dot';dots.appendChild(dot)});

                    calGrid.appendChild(cell);
                }
            }

            const todoListEl = document.getElementById('todoList');
            function renderTodoList(){
                const today = state.selectedDate;
                todoListEl.innerHTML='';
                const todays = state.tasks.filter(t=>t.date===today).sort((a,b)=> (a.time||'')>(b.time||'')?1:-1);
                if(todays.length===0){todoListEl.innerHTML='<div style="color:var(--muted)">No tasks for selected date</div>'}
                todays.forEach(t=>{
                    const el=document.createElement('div');el.className='task';
                    el.innerHTML = `<div><div style="font-weight:600">${escapeHtml(t.title||'Untitled')}</div><small>${t.time||''} ${escapeHtml(t.desc||'')}</small></div><div class="actions"><button data-id="${t.id}" class="btn secondary edit">Edit</button><button data-id="${t.id}" class="btn warn">Delete</button></div>`;
                    todoListEl.appendChild(el);
                });
            }

            function escapeHtml(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            const taskTitle = document.getElementById('taskTitle');
            const taskDate = document.getElementById('taskDate');
            const taskTime = document.getElementById('taskTime');
            const taskDesc = document.getElementById('taskDesc');
            let editingId = null;

            document.getElementById('addTaskBtn').addEventListener('click',()=>{openModal()});
            document.getElementById('closeModal').addEventListener('click',()=>closeModal());
            function openModal(task){
                modal.style.display='flex';
                if(task){editingId=task.id;modalTitle.textContent='Edit Task';taskTitle.value=task.title;taskDate.value=task.date;taskTime.value=task.time||'';taskDesc.value=task.desc||''}
                else{editingId=null;modalTitle.textContent='New Task';taskTitle.value='';taskDate.value=state.selectedDate;taskTime.value='';taskDesc.value=''}
            }
            function closeModal(){modal.style.display='none'}

            document.getElementById('saveTask').addEventListener('click',()=>{
                const rawDate = taskDate.value || state.selectedDate || '';
                const isoDate = normalizeDateInput(rawDate) || state.selectedDate;
                const t = {title:taskTitle.value.trim(),date:isoDate,time:taskTime.value,desc:taskDesc.value};
                if(!t.title) return alert('Please give the task a title');
                if(editingId){
                    const idx = state.tasks.findIndex(x=>x.id===editingId);
                    if(idx>=0){state.tasks[idx]=Object.assign({},state.tasks[idx],t);} 
                } else { state.tasks.push(Object.assign({id:uid(),notified:false},t)); }
                saveTasks();renderCalendar();renderTodoList();closeModal();
            });

            todoListEl.addEventListener('click',e=>{
                if(e.target.matches('button.edit')){
                    const id=e.target.getAttribute('data-id');openModal(state.tasks.find(t=>t.id===id));
                } else if(e.target.matches('button') && e.target.textContent.toLowerCase()==='delete'){
                    const id=e.target.getAttribute('data-id');if(confirm('Delete this task?')){state.tasks=state.tasks.filter(t=>t.id!==id);saveTasks();renderCalendar();renderTodoList();}
                }
            });

            document.getElementById('prevMonth').addEventListener('click',()=>{viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()-1,1);renderCalendar()});
            document.getElementById('nextMonth').addEventListener('click',()=>{viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+1,1);renderCalendar()});
            document.getElementById('todayBtn').addEventListener('click',()=>{viewDate=new Date();state.selectedDate=todayISOLocal();renderCalendar();renderTodoList()});

            const enableNotif = document.getElementById('enableNotif');
            enableNotif.addEventListener('change',()=>{state.notifEnabled = enableNotif.checked; localStorage.setItem('sh_notif', state.notifEnabled); if(state.notifEnabled) requestNotificationPermission();});

            function requestNotificationPermission(){
                if(!('Notification' in window)) return alert('Notifications not supported in this browser');
                Notification.requestPermission().then(p=>{if(p!=='granted'){alert('Please allow notifications to receive due reminders.')}})
            }

            function checkNotifications(){
                if(!state.notifEnabled) return;
                if(Notification.permission!=='granted') return;
                const now = new Date();
                state.tasks.forEach(t=>{
                    if(t.notified) return;
                    if(!t.date || !t.time) return;
                    // build local Date from stored YYYY-MM-DD and HH:MM without relying on Date parsing of strings
                    const when = buildDateTimeFromParts(t.date, t.time);
                    const delta = when - now;
                    if(delta<=0 && delta>-60000){
                        showNotification(`Task due: ${t.title}`, t.desc||'');
                        t.notified = true; saveTasks();
                    }
                });
            }

            function showNotification(title, body){
                try{
                    const n = new Notification(title,{body,icon:''});
                    if(navigator.serviceWorker && navigator.serviceWorker.controller){
                        navigator.serviceWorker.controller.postMessage({type:'show-notif',title,body});
                    }
                }catch(e){console.warn(e)}
            }

            const imageInput = document.getElementById('imageInput');
            const ocrText = document.getElementById('ocrText');
            const runOcrBtn = document.getElementById('runOcrBtn');
            const genHintsBtn = document.getElementById('genHintsBtn');
            const hintsArea = document.getElementById('hintsArea');

            async function preprocessImage(dataUrl, maxWidth = 1600){
                return new Promise((resolve, reject)=>{
                    const img = new Image();
                    img.onload = ()=>{
                        try{
                            const ratio = Math.min(1, maxWidth / img.width);
                            const w = Math.max(1, Math.floor(img.width * ratio));
                            const h = Math.max(1, Math.floor(img.height * ratio));
                            const canvas = document.createElement('canvas');
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);

                            try{
                                const imageData = ctx.getImageData(0,0,w,h);
                                const data = imageData.data;
                                const factor = 1.2;
                                for(let i=0;i<data.length;i+=4){
                                    const r = data[i], g = data[i+1], b = data[i+2];
                                    const avg = (r+g+b)/3;
                                    let v = (avg - 128) * factor + 128;
                                    v = Math.max(0, Math.min(255, v));
                                    data[i] = data[i+1] = data[i+2] = v;
                                }
                                ctx.putImageData(imageData,0,0);
                            }catch(e){
                                console.warn('preprocessImage: imageData failed', e);
                            }

                            resolve(canvas.toDataURL('image/png'));
                        }catch(err){reject(err)}
                    };
                    img.onerror = reject;
                    img.crossOrigin = 'anonymous';
                    img.src = dataUrl;
                });
            }

            runOcrBtn.addEventListener('click', async ()=>{
                const file = imageInput.files[0];
                if(!file) return alert('Choose an image first');
                hintsArea.textContent = 'Loading image...';

                const reader = new FileReader();
                reader.onerror = ()=>{ hintsArea.textContent = 'Failed to read image'; };
                reader.onload = async (e) => {
                    const imgSrc = e.target.result;
                    hintsArea.textContent = 'Preparing image...';

                    try{
                        const pre = await preprocessImage(imgSrc, 1600);

                        const worker = Tesseract.createWorker({
                            logger: m => {
                                if(m.status && typeof m.progress === 'number'){
                                    const pct = Math.round(m.progress * 100);
                                    hintsArea.textContent = `${m.status} — ${pct}%`;
                                }
                            },
                            workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/worker.min.js',
                            corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@2.1.0/tesseract-core.wasm.js'
                        });

                        hintsArea.textContent = 'Initializing OCR engine...';
                        await worker.load();
                        await worker.loadLanguage('eng');
                        await worker.initialize('eng');

                        hintsArea.textContent = 'Recognizing text — this may take a moment...';
                        const { data: { text } } = await worker.recognize(pre);
                        ocrText.value = text;
                        hintsArea.textContent = 'OCR complete — press "Generate Hints"';
                        saveState();

                        await worker.terminate();
                    }catch(err){
                        console.error(err);
                        hintsArea.textContent = 'OCR failed: ' + (err.message || err);
                    }
                };
                reader.readAsDataURL(file);
            });

            genHintsBtn.addEventListener('click',async ()=>{
                const text = (ocrText.value || '').trim();
                if(!text) return alert('Paste or OCR some text first');
                hintsArea.innerHTML = 'Generating hints…';
                genHintsBtn.disabled = true;
                try{
                    // If the user input is a short/simple arithmetic expression, skip remote and use local hints
                    // Normalize simple arithmetic: strip trailing equals or question marks and normalize unicode minus
                    let norm = text.replace(/[=\?]+\s*$/,'').replace(/−/g,'-').trim();
                    if(/^\s*[\d\.\s\+\-\*\/\^\(\),]+\s*$/.test(norm) && norm.length < 240){
                        const local = generateHintsLocal(norm);
                        const arr = Array.isArray(local) ? local : [String(local)];
                        // Render hints
                        hintsArea.innerHTML = arr.map(h=>`<div style="margin-bottom:8px">• ${escapeHtml(h)}</div>`).join('');
                        // Add a reveal-answer button so users can optionally see the computed result
                        const btn = document.createElement('button');
                        btn.className = 'btn secondary';
                        btn.style.marginTop = '8px';
                        btn.textContent = 'Show result';
                        btn.addEventListener('click', ()=>{
                            try{
                                const res = computeArithmeticExpression(norm);
                                const rdiv = document.createElement('div');
                                rdiv.style.marginTop = '10px';
                                rdiv.style.fontWeight = '700';
                                rdiv.textContent = 'Result: ' + String(res);
                                btn.replaceWith(rdiv);
                            }catch(err){
                                alert('Could not compute result: '+(err && err.message));
                            }
                        });
                        try{hintsArea.appendChild(btn);}catch(e){hintsArea.innerHTML += '<div style="margin-top:8px"><button class="btn secondary">Show result</button></div>'}
                        saveState();
                        return;
                    }
                    let hints = await generateHints(text);
                    if(!hints){
                        hints = generateHintsLocal(text);
                    }
                    if(typeof hints === 'string'){
                        try{ const parsed = JSON.parse(hints); if(Array.isArray(parsed)) hints = parsed; }catch(e){ hints = hints.split(/\n+/).map(s=>s.replace(/^\s*[-•\d\.]+\s*/,'').trim()).filter(Boolean); }
                    }
                    if(!Array.isArray(hints)) hints = [String(hints)];
                    if(hints.length === 0) hints = generateHintsLocal(text);
                    hintsArea.innerHTML = hints.map(h=>`<div style="margin-bottom:8px">• ${escapeHtml(h)}</div>`).join('');
                    saveState();
                }catch(e){
                    console.error('generate hints failed', e);
                    const fallback = generateHintsLocal(text);
                    hintsArea.innerHTML = fallback.map(h=>`<div style="margin-bottom:8px">• ${escapeHtml(h)}</div>`).join('');
                    saveState();
                }finally{genHintsBtn.disabled = false}
            });

            document.getElementById('copyHints').addEventListener('click',()=>{navigator.clipboard.writeText(hintsArea.innerText).then(()=>alert('Hints copied'))});
            ocrText.addEventListener('input', ()=> saveState());

            function generateHintsLocal(text){
                const hints = [];
                const lower = (text||'').toLowerCase();

                // Detect simple arithmetic-only expressions like "5 + 6" or "(3+4)*2"
                if(/^\s*[\d\.\s\+\-\*\/\^\(\)]+\s*$/.test(text)){
                    hints.push('This looks like a basic arithmetic expression. Identify the operation: addition, subtraction, multiplication, or division.');
                    hints.push('Follow the order of operations (PEMDAS/BODMAS): parentheses, exponents, multiplication/division, then addition/subtraction.');
                    hints.push('Try simplifying step by step. For example, for 5 + 6 you can add 5 + 5 = 10 then add 1 more to get the final result.');
                    hints.push('If unsure, compute with small steps or use a scratch paper to avoid mistakes.');
                    return hints;
                }

                if(/\bsolve\b|\bequation\b|\bintegral\b|\bdifferentiate\b/i.test(lower) || /[a-z]/i.test(text)){
                    hints.push('Identify what each symbol represents (variables, constants, operators).');
                    hints.push('Separate the problem: what is given and what is asked.');
                    hints.push('Try a simpler numeric example to build intuition.');
                }
                if(/triangle|circle|angle|perimeter|area|radius|diameter/i.test(lower)){
                    hints.push('Sketch the figure and label known sides/angles.');
                    hints.push('Look for symmetries or right angles.');
                }
                if(/algorithm|complexity|sort|array|loop|function|variable/i.test(lower)){
                    hints.push('Break the task into small steps and write pseudocode.');
                    hints.push('Consider edge cases (empty inputs, very large inputs).');
                }
                if(/molecule|reaction|acid|base|cell|photosynthesis/i.test(lower)){
                    hints.push('Identify conservation rules or balances (mass, charge).');
                    hints.push('Summarize definitions and key terms first.');
                }
                hints.push('Restate the problem in your own words.');
                hints.push('If stuck, try specific simple examples.');
                return hints.slice(0,8);
            }

            function buildDateTimeFromParts(ymd, time){
                if(!ymd) return null;
                const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if(!m) return null;
                const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
                let hh = 0, mm = 0;
                if(time){
                    const p = String(time).split(':');
                    hh = parseInt(p[0]||0,10)||0; mm = parseInt(p[1]||0,10)||0;
                }
                return new Date(y, mo, d, hh, mm, 0, 0);
            }

            function computeArithmeticExpression(expr){
                if(!expr) throw new Error('Empty expression');
                const cleaned = String(expr).replace(/\s+/g,'').replace(/,/g,'');
                if(cleaned.length>500) throw new Error('Expression too long');
                const allowed = /^[0-9+\-*/^().]+$/;
                const trans = cleaned.replace(/\^/g,'**');
                if(!allowed.test(trans)) throw new Error('Expression contains unsupported characters');
                try{
                    const fn = new Function('return ('+trans+')');
                    const val = fn();
                    if(typeof val !== 'number' || !isFinite(val)) throw new Error('Invalid numeric result');
                    return val;
                }catch(e){
                    throw new Error('Evaluation failed');
                }
            }

            async function generateHints(text){
                const endpoints = [
                    'http://localhost:3000/api/hints',
                    '/api/hints'
                ];
                let lastError = null;
                for(const url of endpoints){
                    try{
                        const controller = new AbortController();
                        const timeout = setTimeout(()=>controller.abort(), 7000);
                        const resp = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({text}),
                            signal: controller.signal
                        });
                        clearTimeout(timeout);
                        if(!resp.ok){
                            const txt = await resp.text().catch(()=>'<no body>');
                            lastError = `Error ${resp.status} from ${url}: ${txt}`;
                            continue;
                        }
                        const raw = await resp.text().catch(()=>null);
                        if(!raw) continue;
                        try{
                            const parsed = JSON.parse(raw);
                            if(parsed && Array.isArray(parsed.hints) && parsed.hints.length>0) return parsed.hints;
                            if(parsed && parsed.hints) return parsed.hints;
                        }catch(e){
                            const txt = raw.trim();
                            if(txt) return txt;
                        }
                    }catch(err){
                        lastError = (err && err.name==='AbortError') ? `Request to ${url} timed out` : `Request to ${url} failed: ${err && err.message}`;
                        continue;
                    }
                }
                if(lastError) try{hintsArea.innerText = 'Remote hints unavailable: ' + lastError;}catch(e){}
                return generateHintsLocal(text);
            }

            setInterval(checkNotifications,30000);

            loadTasks();
            loadState();
            enableNotif.checked = state.notifEnabled;
            renderCalendar();
            renderTodoList();

            if('serviceWorker' in navigator){
                navigator.serviceWorker.register('sw.js').then(()=>console.log('sw registered')).catch(()=>console.warn('sw failed'));}

            window.SH = {state,save:saveTasks,load:loadTasks};
            window.addEventListener('beforeunload', ()=>{ saveState(); });
        </script>
    </body>
</html>